#!/bin/sh

#FIB_TEMP_COMMAND=${TMPDIR}${$}-fireworks.jsf
FIB_TEMP_DIR=/var/tmp/
FIB_TEMP_COMMAND=${FIB_TEMP_DIR}${$}-fireworks.jsf
FIB_TEMP_FLAG=${FIB_TEMP_DIR}fib_is_running
FIB_WARNINGS_DIR=${2}/warnings
VOLUME_NAME=Macintosh%20HD
PREVIOUSLY_RUNNING_FIREWORKS=$( ps axco pid,command | grep "Adobe Fireworks" | awk '{ print $1 }' )

if [ $# -ne 2 ]; then
  echo "Usage: $0 <full-path-to-png> <full-path-to-project-dir>"
  exit 1
fi

cat > $FIB_TEMP_COMMAND << EOF

try {
  fw.runScript( fw.userJsCommandsDir + '/lib/lib.js' )
  FibExporter.exportCommandLine( "file:///${VOLUME_NAME}${1}", "file:///${VOLUME_NAME}${2}/Resources/" )
} catch( exception ) {
  if( FibHelper && FibHelper.catchException )
    FibHelper.catchException( exception )
}

// This is here instead of fw.quit as fw.quit simply does not work!
// we use a tmp file as a flag to let the script know when fireworks is done
Files.deleteFileIfExisting("file:///${VOLUME_NAME}${FIB_TEMP_FLAG}")

EOF

# Setup
touch $FIB_TEMP_FLAG
if [ ! -d $FIB_WARNINGS_DIR ]; then
    mkdir $FIB_WARNINGS_DIR
fi

rm -rf ${FIB_WARNINGS_DIR}/*_warnings.txt

open -ga "Adobe Fireworks CS5" $FIB_TEMP_COMMAND

# HACK: wait for temp file to be gone before continuing
# cannot use open -W as no easy way to close a new instance of Fireworks
# from within Fireworks
while true
do
    [ ! -f ${FIB_TEMP_FLAG} ] && break
    sleep 2
done

echo "\nFinished Exporting from Adobe Fireworks\n"

# cleanup our old command
rm -rf $FIB_TEMP_COMMAND

# early out if warnings directory is empty
if [ ! "$(ls -A ${FIB_WARNINGS_DIR})" ]; then
   echo "No warnings.\n"
   exit
fi

# stdout warnings that are saved to file...
echo "Warnings:\n"
for WARNING_FILE in ${FIB_WARNINGS_DIR}/*
do
    # using strings here because it linebreaks the ^M character
    FILE_NAME=$(basename $WARNING_FILE):
    echo ${FILE_NAME%_warnings.*}" warnings:\n"
    strings $WARNING_FILE
    echo "\n"
done


